name: Create Release

on:
  push:
    tags:
      - 'v*' # Triggers on version tags (e.g., v1.0.0)

  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        default: 'v0.0.0'
      prerelease:
        description: 'Is this a pre-release?'
        required: false
        type: boolean
        default: false

jobs:
  build-alpine:
    name: Build Alpine Linux
    runs-on: ubuntu-latest
    container:
      image: alpine:latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build with Alpine
        run: |
          apk add --no-cache build-base cmake git make
          mkdir build && cd build
          cmake ..
          make
          file initc | grep "statically linked" || echo "Warning: Binary may not be statically linked"
          tar -czf ../cinit-linux-musl-alpine.tar.gz initc

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: cinit-linux-musl-alpine
          path: cinit-linux-musl-alpine.tar.gz

  build-macos:
    name: Build macOS (x86_64)
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build on macOS
        run: |
          mkdir build && cd build
          cmake -DCMAKE_OSX_ARCHITECTURES="x86_64" ..
          make
          tar -czf ../cinit-macos-x86_64.tar.gz initc

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: cinit-macos-x86_64
          path: cinit-macos-x86_64.tar.gz

  release:
    name: Create Release
    needs: [build-alpine, build-macos]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Get release tag
        id: get_tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "RELEASE_TAG=${{ github.event.inputs.release_tag }}" >> $GITHUB_ENV
            echo "IS_PRERELEASE=${{ github.event.inputs.prerelease }}" >> $GITHUB_ENV
          else
            echo "RELEASE_TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
            echo "IS_PRERELEASE=false" >> $GITHUB_ENV
          fi

      - name: Setup GitHub CLI
        run: |
          type -p curl >/dev/null || sudo apt install curl -y
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
          && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
          && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
          && sudo apt update \
          && sudo apt install gh -y

      - name: Create Release Notes
        run: |
          cat > release_notes.md << 'EOL'
          # cinit ${{ env.RELEASE_TAG }}
            
          ## Downloads
          - Linux (Alpine, statically linked with musl): cinit-linux-musl-alpine.tar.gz
          - macOS (x86_64): cinit-macos-x86_64.tar.gz
            
          ## Changes
          - Feature improvements
          - Bug fixes
            
          For more details, please check the [README](https://github.com/${{ github.repository }}/blob/main/README.md).
          EOL

      - name: Create Release and Upload Assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # For auto-triggered by tag push
          if [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
            gh release create ${RELEASE_TAG} \
              --title "Release ${RELEASE_TAG}" \
              --notes-file release_notes.md \
              cinit-linux-musl-alpine/cinit-linux-musl-alpine.tar.gz \
              cinit-macos-x86_64/cinit-macos-x86_64.tar.gz
          else
            # For manually triggered runs, check if the tag already exists
            if gh release view ${RELEASE_TAG} &>/dev/null; then
              echo "Release ${RELEASE_TAG} already exists, updating it"
              gh release upload ${RELEASE_TAG} \
                cinit-linux-musl-alpine/cinit-linux-musl-alpine.tar.gz \
                cinit-macos-x86_64/cinit-macos-x86_64.tar.gz --clobber
            else
              # Create new release
              PRERELEASE_FLAG=""
              if [ "${IS_PRERELEASE}" = "true" ]; then
                PRERELEASE_FLAG="--prerelease"
              fi
              
              gh release create ${RELEASE_TAG} \
                --title "Release ${RELEASE_TAG}" \
                --notes-file release_notes.md \
                ${PRERELEASE_FLAG} \
                cinit-linux-musl-alpine/cinit-linux-musl-alpine.tar.gz \
                cinit-macos-x86_64/cinit-macos-x86_64.tar.gz
            fi
          fi
